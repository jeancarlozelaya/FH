<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Editor de Imágenes</title>
    <!-- FontAwesome para los íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- JSZip y FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* Estilos generales */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 8px;
            text-align: center;
        }

        h1 {
            font-size: 18px;
            margin: 0;
        }

        /* Contenedor principal */
        .container {
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Diseño mejorado para el input de carga de archivos */
        .file-upload {
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .file-upload:hover {
            background-color: #2980b9;
        }

        .file-upload input[type="file"] {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Botones con íconos */
        .button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .button-container button {
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 15px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            width: 50px;
            height: 50px;
        }

        .button-container button#clearButton {
            background-color: #e74c3c;
        }

        .button-container button:hover {
            background-color: #2ecc71;
        }

        .button-container button#clearButton:hover {
            background-color: #c0392b;
        }

        /* Estilos de la tabla */
        table {
            width: 100%;
            max-width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 6px;
            text-align: center;
            font-size: 14px;
            border: 1px solid #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background-color: #34495e;
            color: white;
            font-size: 13px;
            padding: 8px;
        }

        /* Ajuste de anchos de columnas */
        th:nth-child(1), td:nth-child(1) { width: 15%; } /* Imagen */
        th:nth-child(2), td:nth-child(2) { width: 20%; } /* Precio App */
        th:nth-child(3), td:nth-child(3) { width: 10%; } /* ISV */
        th:nth-child(4), td:nth-child(4) { width: 15%; } /* Precio Lempiras */
        th:nth-child(5), td:nth-child(5) { width: 15%; } /* Precio */
        th:nth-child(6), td:nth-child(6) { width: 15%; } /* Talla */

        /* Inputs y Selects */
        td input, td select {
            width: 100%;
            height: 30px;
            font-size: 13px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
            box-sizing: border-box;
            background-color: #fff;
        }

        /* Precio App y Precio con tamaño fijo */
        .precioApp, .precio {
            width: 100%;
            max-width: 80px;
            min-width: 80px;
        }

        /* Lista desplegable de ISV más compacta */
        td select.isv {
            width: 70px;
            height: 30px;
            font-size: 13px;
            padding: 2px;
            cursor: pointer;
        }

        /* Imagen más grande */
        td img {
            max-width: 70px;
            max-height: 70px;
            object-fit: cover;
            border-radius: 6px;
        }

        /* RESPONSIVIDAD */
        @media (max-width: 768px) {
            table {
                width: 100%;
                font-size: 12px;
            }

            th, td {
                padding: 4px;
            }

            .button-container button {
                font-size: 16px;
                padding: 12px;
                width: 45px;
                height: 45px;
            }

            td img {
                max-width: 60px;
                max-height: 60px;
            }

            td select.isv {
                width: 65px;
                font-size: 12px;
            }

            .precioApp, .precio {
                max-width: 75px;
                min-width: 75px;
            }
        }

        @media (max-width: 480px) {
            th, td {
                font-size: 11px;
                padding: 3px;
            }

            .button-container button {
                font-size: 14px;
                padding: 10px;
                width: 40px;
                height: 40px;
            }

            td img {
                max-width: 50px;
                max-height: 50px;
            }

            td select.isv {
                width: 60px;
                font-size: 11px;
            }

            .precioApp, .precio {
                max-width: 70px;
                min-width: 70px;
            }
        }

        /* Evitar zoom en iPhone */
        input, select, textarea, button {
            font-size: 16px; /* Tamaño de fuente mínimo para evitar zoom */
        }
    </style>
</head>
<body>
    <header>
        <h1>Editor de Imágenes</h1>
    </header>
    <div class="container">
        <!-- Diseño mejorado para el input de carga de archivos -->
        <label class="file-upload">
            <i class="fas fa-upload"></i> Subir imágenes
            <input type="file" id="imageUpload" multiple accept="image/*">
        </label>

        <!-- Botones con íconos -->
        <div class="button-container">
            <button onclick="downloadImages()" title="Descargar imágenes">
                <i class="fas fa-download"></i>
            </button>
            <button onclick="downloadImagesAsZip()" title="Descargar imágenes en ZIP">
                <i class="fas fa-file-archive"></i>
            </button>
            <button id="clearButton" onclick="clearTable()" title="Borrar datos">
                <i class="fas fa-trash"></i>
            </button>
        </div>

        <!-- Tabla -->
        <table id="imageTable">
            <thead>
                <tr>
                    <th>Foto</th>
                    <th>Precio App</th>
                    <th>ISV</th>
                    <th>Precio Lempiras</th>
                    <th>Precio</th>
                    <th>Talla</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const logo = new Image();
        logo.src = ''; // Asegúrate de que esta ruta sea correcta

        let db;
        const request = indexedDB.open('ImageDB', 1);

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains('images')) {
                db.createObjectStore('images', { keyPath: 'id', autoIncrement: true });
            }
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            console.log('IndexedDB abierto correctamente');
            loadTableData();
        };

        request.onerror = function(event) {
            console.error('Error al abrir IndexedDB:', event.target.error);
        };

        function saveImageToIndexedDB(imageData, callback) {
            const transaction = db.transaction(['images'], 'readwrite');
            const store = transaction.objectStore('images');
            const request = store.add({ image: imageData });

            request.onsuccess = function(event) {
                console.log('Imagen guardada en IndexedDB con ID:', event.target.result);
                callback(event.target.result);
            };

            request.onerror = function(event) {
                console.error('Error al guardar la imagen en IndexedDB:', event.target.error);
            };
        }

        function getImageFromIndexedDB(id, callback) {
            const transaction = db.transaction(['images'], 'readonly');
            const store = transaction.objectStore('images');
            const request = store.get(id);

            request.onsuccess = function(event) {
                callback(event.target.result ? event.target.result.image : null);
            };

            request.onerror = function(event) {
                console.error('Error al recuperar la imagen de IndexedDB:', event.target.error);
            };
        }

function compressImage(image, callback, quality = 0.8) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Usar las dimensiones originales de la imagen, sin redimensionar
    const width = image.width;
    const height = image.height;

    canvas.width = width;
    canvas.height = height;
    ctx.drawImage(image, 0, 0, width, height);

    // Convertir la imagen a un formato comprimido (WebP)
    canvas.toBlob(function(blob) {
        const reader = new FileReader();
        reader.onload = function() {
            callback(reader.result);  // Pasar la imagen comprimida
        };
        reader.readAsDataURL(blob);
    }, 'image/webp', quality);  // Ajusta el valor de calidad (0 a 1)
}

document.getElementById('imageUpload').addEventListener('change', function(event) {
    const files = event.target.files;
    const tbody = document.querySelector('#imageTable tbody');
    
    for (let file of files) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const image = new Image();
            image.src = e.target.result;

            image.onload = function() {
                compressImage(image, function(compressedImage) {
                    // Aquí puedes aplicar el corte si es necesario antes de guardarlo
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const cropTop = 500;
                    const cropBottom = 150;
                    const croppedHeight = image.height - cropTop - cropBottom;

                    canvas.width = image.width;
                    canvas.height = croppedHeight;

                    ctx.drawImage(image, 0, cropTop, image.width, croppedHeight, 0, 0, canvas.width, canvas.height);

                    // Convertir la imagen cortada a base64
                    canvas.toBlob(function(blob) {
                        const reader = new FileReader();
                        reader.onload = function() {
                            const croppedImageData = reader.result;

                            // Guardar la imagen modificada en IndexedDB
                            saveImageToIndexedDB(croppedImageData, function(id) {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td><img src="${croppedImageData}" data-id="${id}"></td>
                                    <td><input type="number" class="precioApp" oninput="updatePrice(this)"></td>
                                    <td>
                                        <select class="isv" onchange="updatePrice(this)">
                                            <option value="0.2">20%</option>
                                            <option value="0.25">25%</option>
                                            <option value="0.35">35%</option>
                                        </select>
                                    </td>
                                    <td class="precioLempiras">0</td>
                                    <td><input type="number" class="precio" oninput="saveTableData()"></td>
                                    <td><input type="text" class="talla" oninput="saveTableData()"></td>
                                `;
                                tbody.appendChild(row);
                                saveTableData();
                            });
                        };
                        reader.readAsDataURL(blob);
                    }, 'image/webp', 0.8);  // Ajusta el valor de calidad (0 a 1)
                });
            };
        };
        reader.readAsDataURL(file);
    }
});


        function updatePrice(element) {
            const row = element.closest('tr');
            const precioApp = parseFloat(row.querySelector('.precioApp').value) || 0;
            const isv = parseFloat(row.querySelector('.isv').value) || 0;
            const precioLempiras = ((precioApp * 26) + 50) * (1 + isv);
            row.querySelector('.precioLempiras').textContent = precioLempiras.toFixed(2);
            saveTableData();
        }

        function saveTableData() {
            const tableData = [];
            document.querySelectorAll('#imageTable tbody tr').forEach(row => {
                const img = row.querySelector('img').src;
                const precioApp = row.querySelector('.precioApp').value;
                const isv = row.querySelector('.isv').value;
                const precioLempiras = row.querySelector('.precioLempiras').textContent;
                const precio = row.querySelector('.precio').value;
                const talla = row.querySelector('.talla').value;
                
                tableData.push({ img, precioApp, isv, precioLempiras, precio, talla });
            });
            localStorage.setItem('tableData', JSON.stringify(tableData));
        }

        function loadTableData() {
            const tbody = document.querySelector('#imageTable tbody');
            tbody.innerHTML = '';
            const tableData = JSON.parse(localStorage.getItem('tableData')) || [];
            
            tableData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${data.img}"></td>
                    <td><input type="number" class="precioApp" value="${data.precioApp}" oninput="updatePrice(this)"></td>
                    <td>
                        <select class="isv" onchange="updatePrice(this)">
                            <option value="0.2" ${data.isv == 0.2 ? 'selected' : ''}>20%</option>
                            <option value="0.25" ${data.isv == 0.25 ? 'selected' : ''}>25%</option>
                            <option value="0.35" ${data.isv == 0.35 ? 'selected' : ''}>35%</option>
                        </select>
                    </td>
                    <td class="precioLempiras">${data.precioLempiras}</td>
                    <td><input type="number" class="precio" value="${data.precio}" oninput="saveTableData()"></td>
                    <td><input type="text" class="talla" value="${data.talla}" oninput="saveTableData()"></td>
                `;
                tbody.appendChild(row);
            });
        }




           function downloadImages() {
    const rows = document.querySelectorAll('#imageTable tbody tr');
    let index = 0;

    function downloadNextImage() {
        if (index >= rows.length) {
            console.log('Todas las imágenes han sido descargadas.');
            return;
        }

        const row = rows[index];
        const img = row.querySelector('img');
        const precio = row.querySelector('.precio').value;
        const talla = row.querySelector('.talla').value;

        if (!img || !img.src) {
            console.error('No se encontró una imagen válida en la fila:', row);
            index++;
            downloadNextImage(); // Continuar con la siguiente imagen
            return;
        }

        const image = new Image();
        image.crossOrigin = "anonymous"; // Permitir el uso de imágenes externas si es necesario
        image.src = img.src;

image.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Usar las dimensiones originales de la imagen, sin redimensionar ni recortar
            canvas.width = image.width;
            canvas.height = image.height;

            ctx.drawImage(image, 0, 0, image.width, image.height);

            // Dibujar el logo en la parte superior izquierda
            if (logo.complete) {
                const logoWidth = 100; // Ancho del logo
                const logoHeight = (logo.height / logo.width) * logoWidth; // Mantener la proporción
                ctx.drawImage(logo, 10, 10, logoWidth, logoHeight);
            }

            // Dibujar talla en la parte izquierda
            ctx.font = 'bold 50px Arial';
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, canvas.height - 420, canvas.width, 70);
            ctx.fillStyle = 'white';
            ctx.textAlign = 'left';
            ctx.fillText(talla, 20, canvas.height - 370);

            // Dibujar precio en la parte derecha
            ctx.textAlign = 'right';
            ctx.fillText("L. " + precio, canvas.width - 20, canvas.height - 370);

            // Descargar la imagen
            const link = document.createElement('a');
            link.download = `editado_${index + 1}.png`;
            link.href = canvas.toDataURL();
            link.click();

            index++;
            setTimeout(downloadNextImage, 100); // Esperar 100ms antes de descargar la siguiente imagen
        };

        image.onerror = function() {
            console.error('Error al cargar la imagen:', img.src);
            index++;
            downloadNextImage(); // Continuar con la siguiente imagen
        };
    }

    downloadNextImage();
}

function downloadImagesAsZip() {
    const zip = new JSZip();
    const rows = document.querySelectorAll('#imageTable tbody tr');
    let index = 0;

    function addNextImageToZip() {
        if (index >= rows.length) {
            zip.generateAsync({ type: "blob" }).then(function(content) {
                saveAs(content, "imagenes.zip");
                console.log('Todas las imágenes han sido comprimidas en el archivo ZIP.');
            });
            return;
        }

        const row = rows[index];
        const img = row.querySelector('img');
        const precio = row.querySelector('.precio').value;
        const talla = row.querySelector('.talla').value;

        if (!img || !img.src) {
            console.error('No se encontró una imagen válida en la fila:', row);
            index++;
            addNextImageToZip(); // Continuar con la siguiente imagen
            return;
        }

        const image = new Image();
        image.crossOrigin = "anonymous"; // Permitir el uso de imágenes externas si es necesario
        image.src = img.src;

        image.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Usar las dimensiones originales de la imagen, sin redimensionar ni recortar
            canvas.width = image.width;
            canvas.height = image.height;

            ctx.drawImage(image, 0, 0, image.width, image.height);

            // Dibujar el logo en la parte superior izquierda
            if (logo.complete) {
                const logoWidth = 100; // Ancho del logo
                const logoHeight = (logo.height / logo.width) * logoWidth; // Mantener la proporción
                ctx.drawImage(logo, 10, 10, logoWidth, logoHeight);
            }

            // Dibujar talla en la parte izquierda
            ctx.font = 'bold 50px Arial';
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, canvas.height - 420, canvas.width, 70);
            ctx.fillStyle = 'white';
            ctx.textAlign = 'left';
            ctx.fillText(talla, 20, canvas.height - 370);

            // Dibujar precio en la parte derecha
            ctx.textAlign = 'right';
            ctx.fillText("L. " + precio, canvas.width - 20, canvas.height - 370);

            // Convertir el canvas a un blob y agregarlo al ZIP
            canvas.toBlob(function(blob) {
                zip.file(`editado_${index + 1}.png`, blob);
                index++;
                addNextImageToZip(); // Continuar con la siguiente imagen
            }, 'image/png');
        };

        image.onerror = function() {
            console.error('Error al cargar la imagen:', img.src);
            index++;
            addNextImageToZip(); // Continuar con la siguiente imagen
        };
    }

    addNextImageToZip();
}

        function clearTable() {
            const tbody = document.querySelector('#imageTable tbody');
            tbody.innerHTML = '';
            localStorage.removeItem('tableData');
        }

        window.addEventListener('load', loadTableData);
    </script>
</body>
</html>
